version: '2'
services:
  sphinx:
    build:
      context: sphinx
    ports:
    - "127.0.0.1:36307:36307" # bind to local interface only!
    volumes:
    - ./sphinx/data:/opt/sphinx/index
    - ./sphinx/sphinx.conf:/opt/sphinx/conf/sphinx.conf
    mem_limit: 512m # match indexer.value from sphinx.conf
    logging:
      driver: syslog
      options:
        tag: wbc-sphinx
    hostname: sphinx-docker
  # Flask app
  app:
    build:
      context: app
    command: "gunicorn wbc:app -b 0.0.0.0:8080 --access-logfile -"
    volumes:
    - ./app/sitemap:/opt/app/wbc/sitemap
    environment:
      GIT_HASH: "${GIT_HASH}"
    logging:
      driver: syslog
      options:
        tag: wbc-app
    hostname: "app-docker-${HOST}"
  # nginx proxy
  nginx:
    # https://hub.docker.com/r/macbre/nginx-brotli
    image: macbre/nginx-brotli:latest
    volumes:
      # mount cache directory
      - ./nginx/cache:/var/nginx/cache
      # mount SSL certificate files
      - ./nginx/wbc.macbre.net.cer:/etc/nginx/cert/wbc.macbre.net.cer
      - ./nginx/wbc.macbre.net.key:/etc/nginx/cert/wbc.macbre.net.key
      # mount site config
      - ./nginx/site.conf:/etc/nginx/conf.d/wbc.conf
      # common config files
      - ./nginx/gzip.conf:/etc/nginx/conf.d/gzip.conf
      - ./nginx/caching.conf:/etc/nginx/conf.d/caching.conf
    ports:
    - "${NGINX_HTTP_PORT}:81"
    - "443:443"
    logging:
      driver: syslog
      options:
        tag: wbc-nginx
    hostname: "nginx-docker-${HOST}"
    depends_on:
    - app
    - sphinx
    restart: always
